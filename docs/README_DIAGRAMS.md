# LaTeX Math FSM - State Machine Diagrams 📊

This directory contains comprehensive state machine diagrams and visualizations for the LaTeX Math Finite State Machine (FSM).

## 🎯 Overview

The LaTeX Math FSM is a sophisticated state machine that processes LaTeX mathematical expressions token-by-token to ensure syntactic validity. It handles complex mathematical constructs including:

- **Fractions**: `\frac{numerator}{denominator}`
- **Superscripts/Subscripts**: `x^2`, `a_{i+1}`
- **Commands**: `\alpha`, `\sum`, `\int`, `\sqrt`
- **Nested Braces**: `{a + {b \cdot c}}`
- **Complex Expressions**: `$\sum_{i=1}^n \frac{x_i^2}{\sigma^2}$`

## 📁 Files and Diagrams

### 1. **Static Diagrams** 🖼️

Generated by `fsm_diagram.py`:

- **`latex_fsm_detailed.png`**: Comprehensive state diagram showing all states and transitions
- **`latex_fsm_simplified.png`**: High-level overview focusing on main flow
- **`latex_fsm_trace.png`**: Example processing trace for `$\frac{x^2}{y+1}$`

### 2. **Interactive Visualizations** 🎮

Provided by `fsm_visualizer.py`:

- **State Diagram**: Interactive Plotly diagram with hover details
- **Token Flow**: Real-time visualization of token processing
- **Statistics**: State usage frequency and metrics
- **Transition Matrix**: Heatmap showing state transition patterns

### 3. **Documentation** 📚

- **`FSM_DOCUMENTATION.md`**: Complete technical specification
- **`MERMAID_DIAGRAMS.md`**: Mermaid diagrams for GitHub/documentation
- **`README_DIAGRAMS.md`**: This file

## 🚀 Usage

### Generate Static Diagrams

```bash
# Install dependencies
uv add matplotlib networkx numpy

# Generate all diagrams
uv run python fsm_diagram.py
```

### Run Interactive Visualizer

```bash
# Install additional dependencies  
uv add plotly pandas

# Launch Streamlit app with enhanced visualizer
uv run streamlit run streamlit_app.py
```

### View Mermaid Diagrams

1. **GitHub**: Open `MERMAID_DIAGRAMS.md` - diagrams render automatically
2. **VS Code**: Install "Mermaid Preview" extension
3. **Online**: Copy diagrams to [Mermaid Live Editor](https://mermaid.live/)

## 🎭 State Machine Structure

### Core States

```
START → MATH_MODE → [COMMAND/SUPERSCRIPT/SUBSCRIPT/CONTENT] → END_STATE
```

### State Descriptions

| State | Description | Triggers | Next States |
|-------|-------------|----------|-------------|
| **START** | Initial state | `$`, `$$`, `\[` | MATH_MODE |
| **MATH_MODE** | Core math processing | variables, numbers, operators | COMMAND, SUPERSCRIPT, SUBSCRIPT, CONTENT, END_STATE |
| **COMMAND** | LaTeX command processing | `\frac`, `\sum`, etc. | BRACE_OPEN |
| **CONTENT** | Inside braces `{}` | any valid content | MATH_MODE, CONTENT |
| **SUPERSCRIPT** | After `^` | single char or `{` | MATH_MODE, CONTENT |
| **SUBSCRIPT** | After `_` | single char or `{` | MATH_MODE, CONTENT |
| **END_STATE** | Valid completion | `$`, `$$`, `\]` | (terminal) |

### Example Processing Traces

#### Simple: `$x^2$`
```
$ → math_mode → x → math_mode → ^ → superscript → 2 → math_mode → $ → end_state
```

#### Complex: `$\frac{a+1}{b}$`
```
$ → math_mode → \frac → fraction_num → { → content → a → content → + → content 
→ 1 → content → } → fraction_den → { → content → b → content → } → math_mode → $ → end_state
```

## 🎨 Visualization Features

### Interactive State Diagram
- **Hover Details**: State descriptions and valid transitions
- **Color Coding**: Different state types (start/end, math, command, content, special)
- **Clickable States**: View detailed information
- **Transition Arrows**: Show valid state changes

### Real-Time Processing
- **Token-by-Token**: Watch FSM process expressions step by step
- **State Tracking**: See current state highlighted
- **Validation Feedback**: Immediate feedback on valid/invalid tokens
- **Path Visualization**: Complete FSM path through expression

### Statistics and Metrics
- **State Frequency**: How often each state is visited
- **Complexity Metrics**: Number of supported commands, variables, operators
- **Transition Matrix**: Heatmap showing state transition patterns
- **Performance Stats**: Processing speed and accuracy

## 🔧 Technical Implementation

### FSM Architecture
- **Token-based Processing**: Each LaTeX token moves FSM through states
- **Depth Tracking**: Maintains nesting levels for braces `{}`, brackets `[]`, parentheses `()`
- **Command Validation**: 200+ supported LaTeX commands
- **Error Recovery**: Graceful handling of invalid inputs

### Integration with LLMs
1. **Free Generation**: LLM generates LaTeX expression naturally
2. **Extraction**: Extract LaTeX from response using regex patterns
3. **Validation**: Process through FSM for syntactic correctness
4. **Guidance**: If invalid, guide LLM to generate valid expressions

### Supported LaTeX Features
- **Commands**: `\frac`, `\sqrt`, `\sum`, `\int`, `\alpha`, `\beta`, etc.
- **Operators**: `+`, `-`, `*`, `/`, `=`, `\leq`, `\geq`, `\neq`
- **Structures**: Fractions, superscripts, subscripts, nested braces
- **Delimiters**: `$...$`, `$$...$$`, `\[...\]`

## 📊 Performance Characteristics

- **Processing Speed**: O(n) where n = number of tokens
- **Memory Usage**: O(1) state storage + O(d) depth tracking
- **Validation Accuracy**: 100% syntactic correctness for supported constructs
- **Command Coverage**: 200+ LaTeX mathematical commands

## 🌟 Applications

### Educational Tools
- **Math Expression Validation**: Check student LaTeX input
- **Interactive Learning**: Step-by-step LaTeX construction
- **Error Explanation**: Detailed feedback on syntax errors

### Content Generation
- **AI-Assisted Writing**: Guide LLMs to generate valid LaTeX
- **Document Processing**: Validate mathematical expressions in documents
- **Template Generation**: Ensure LaTeX templates are syntactically correct

### Development Tools
- **LaTeX Editors**: Real-time syntax validation
- **Code Completion**: Suggest valid next tokens
- **Error Prevention**: Prevent invalid LaTeX construction

## 🚨 Limitations

- **Semantic Validation**: FSM ensures syntax, not mathematical correctness
- **Command Coverage**: Limited to predefined command set (extensible)
- **Complex Environments**: Some advanced LaTeX environments not fully supported
- **Performance**: Large expressions may require optimization

## 🔮 Future Enhancements

- **Semantic Validation**: Mathematical correctness checking
- **Extended Commands**: Support for more LaTeX packages
- **Error Recovery**: Automatic correction suggestions
- **Performance Optimization**: Faster processing for large documents
- **Visual Editor**: Drag-and-drop LaTeX construction

---

## 🎯 Quick Start

1. **View Static Diagrams**: Open PNG files in any image viewer
2. **Interactive Exploration**: Run `streamlit run streamlit_app.py`
3. **Documentation**: Read `FSM_DOCUMENTATION.md` for technical details
4. **GitHub Integration**: View `MERMAID_DIAGRAMS.md` for embedded diagrams

**Need help?** Check the main project README or create an issue on GitHub!

---

*Generated for the LaTeX Math FSM project - Constraining LLMs with Finite State Machines* 🧮